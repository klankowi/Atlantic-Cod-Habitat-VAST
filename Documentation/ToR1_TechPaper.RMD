---
title: 'Atlantic Cod VAST Model Technical Document'
author: Katie Lankowicz
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::pdf_document2:
    latex_engine: lualatex
    includes: 
       in_header: header1.tex
    keep_tex: true
  bookdown::html_document2: 
    toc: true
    toc_float: true
  bookdown::word_document2:
    toc: true
link-citations: yes
csl: "american-fisheries-society.csl"
bibliography: Cod_VAST.bib
always_allow_html: true
header-includes:
    - \usepackage{setspace}\onehalfspacing
    - \usepackage{float}
    - \usepackage{caption}
    - \captionsetup[figure]{labelformat=empty}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      message = FALSE,
                      warning = FALSE)

library(tidyverse)
library(here)
library(DT)
library(pdftools)
library(patchwork)
library(ggiraph)
library(TMB)
library(units)
library(VAST)
library(here)
library(tidyverse)
library(beepr)
library(sf)
library(rgdal)
library(sp)
library(ggcorrplot)
library(kableExtra)
library(pander)
# Add unitless back as possible unit (removed in units package update Mar 2023)
install_unit(symbol='unitless', def='unitless', name='unitless')
# Set GGplot auto theme
theme_set(theme(panel.grid.major = element_line(color='lightgray'),
                panel.grid.minor = element_blank(),
                panel.background = element_blank(),
                panel.border = element_rect(color='black', size=1, fill=NA),
                legend.position = "bottom",
                axis.text.x=element_text(size=11),
                axis.text.y=element_text(size=11),
                axis.title.x=element_text(size=12),
                axis.title.y=element_text(size=12, angle=90, vjust=2),
                plot.title=element_text(size=14, hjust = 0, vjust = 1.2),
                plot.caption=element_text(hjust=0, face='italic', size=12)))

library(webshot)
if(is.null(webshot:::find_phantom())){webshot::install_phantomjs()}

options(DT.options = list(pageLength = 100))

```

# Abstract
The spatial distribution of the Atlantic cod (_Gadus morhua_) population is shaped by a suite of habitat and oceanographic variables. Additional complexity is added by differences in environmental preferences between life-history phases and spatially-separated stocks. Multiple bottom trawl survey programs have been developed to assess groundfish abundance in the Northeastern US continental shelf (NEUS), most notably the Northeast Fishery Science Center's twice-annual bottom trawl survey. Groundfish indices of abundance are typically calculated using data from these bottom trawl surveys. However, bottom trawls have reduced efficiency in complex bottom habitats that are highly suitable for Atlantic cod. It would be advantageous to calculate an index of cod abundance from a combination of bottom trawl survey data and data from other survey platforms to help bridge this gap. In this study, Vector Autoregressive Spatio-Temporal (VAST) models were used to combine data from survey programs using bottom trawls, bottom longlines, and video trawls to hindcast seasonal spatial density of three size classes of cod within the NEUS from 1982-2021. Bottom habitat characteristics (sediment type, rugosity, and depth), bottom water temperature, and basin-averaged climate indices (North Atlantic Oscillation, Atlantic Multidecadal Oscillation) were included as covariates to improve predictions of population density. Indices of abundance were generated for each size class within the four spatially distinct stock areas of the cod population. Abundance of all size classes generally decreased within all stock areas. 

# Introduction
Atlantic cod (_Gadus morhua_) are an ecologically, economically, and culturally critical part of New England's groundfish fishery. However, the fishery has been under a disaster declaration since 2012 due to historically low abundance and rapidly declining stocks. Atlantic cod population assessments and management efforts are informed by a suite of bottom trawl surveys, perhaps most notably by the Northeast Fishery Science Center's (NEFSC) twice-annual bottom trawl survey. This survey has been an important tool to assess groundfish stocks from Cape Hatteras, NC to Nova Scotia since the early 1960s. However, bottom trawl surveys like the NEFSC bottom trawl are known to have reduced efficiency over complex bottom habitats such as cobble fields and rocky ledges [@grabowski_2020]. Most bottom trawl survey programs have low sampling effort within complex habitat areas due to risks to the equipment, and will instead focus on sampling in areas deeper than 18m and with soft and smooth bottom habitat. 

The limitation of survey information within more complex areas is concerning to fishing industry stakeholders and fishery managers alike; several life history phases of cod are known to associate with complex bottom habitat areas. Juvenile cod have been found in higher densities over cobble and boulder habitats, likely as a refuge from predation [@gotceitas_1993 @gotceitas_1995 @grabowski_2018 @linner_2022]. Industry stakeholders have also reported relatively high density of large cod within hard-bottom habitats, possibly indicating a density-dependent reduction in large cod spatial distribution and altered availability to bottom trawl surveys [@mcelroy_2021]. Stakeholders' observations of high cod density over complex bottom habitat have created the perception that cod abundance is much higher than what bottom trawl-informed assessments have suggested.

The objective of this project is to build a joint index of abundance and annual maps of spatial density for Atlantic cod using all relevant state and federal groundfish survey data. Creating a joint index of cod abundance using survey data spanning inshore, offshore, smooth, and complex bottom habitats would improve our understanding of cod spatial dynamics and demographics, which in turn would benefit management efforts and help rectify opposing perceptions of cod population size. These alternative data sources do exist, albeit typically with much shorter time series than the NEFSC bottom trawl survey. Many state and academic institutions conduct bottom trawl surveys that may help to fill data gaps for groundfish stocks in shallower inshore waters. The NEFSC has also launched a cooperative bottom longline survey to explore groundfish abundance and distribution in areas with high-complexity bottom habitat.

This research objective will be addressed using Vector Autoregressive Spatio-Temporal (VAST) models. VAST models estimate spatial density of multiple categories of a target organism conditioned on density covariates and controlling for catchability covariates. These estimates of spatial density can then be used in the calculation of indices of abundance. We will utilize multiple trawl surveys and a suite of habitat and environmental covariates to explore patterns in habitat use and create indices of abundance for Atlantic cod.

# Methods

## Survey Data
Eleven surveys of groundfish abundance are currently available for use. Overall spatial coverage runs along the coast from Lubec, Maine to Cape Hatteras, North Carolina and spans the four defined cod spatial stock areas: Eastern Gulf of Maine, Western Gulf of Maine, Georges Bank, and Southern New England. Overall temporal coverage spans from 1959 - 2022. Included surveys are:

* NEFSC Cooperative Bottom Longline Survey (longline)
* Eastern Gulf of Maine Sentinel Survey (jigging)
* SMAST Video Trawl Survey (combined trawl-camera)
* NEFSC Bottom Trawl Survey (trawl)
* DFO Bottom Trawl Survey (trawl)
* University of Rhode Island GSO Trawl Survey (trawl)
* Massachusetts DMF Industry-based survey (trawl)
* Massachusetts DMF Inshore Trawl Survey (trawl)
* Maine-New Hampshire Inshore Trawl Survey (trawl)
* Rhode Island DEM Trawl Survey (trawl)
* ASMFC Shrimp Trawl Survey (trawl)

These surveys utilize different gears and methods, have variable spatial extents, are completed in either annually or seasonally, and are of variable temporal length (as in, number of years in which the survey has occurred). All surveys report number of cod and total weight (kg) of cod caught per tow, and some surveys process all or a portion of the catch to provide further biological detail.

## VAST
VAST models were used to estimate cod spatial density over time and create joint indices of abundance using all available groundfish survey data. VAST is a framework for implementing spatial delta-generalized linear mixed models (delta-GLMM) and can be manipulated to provide estimates for multiple categories of interest and spatial strata [@thorson_accounting_2017 @thorson_2019]. It is structured to utilize two linear predictors; the first linear predictor estimates encounter probability, and the second linear predictor estimates catch rates. The first linear predictor can be represented as

$$\rho_1(i) = \beta_1(c_i, t_i) + \omega_1^*(s_i, c_i) + \varepsilon_1^*(s_i, c_i, t_i) + \eta_1(v_i, c_i) + \nu_1(c_i, t_i)$$

where $\rho_1(i)$ is the predictor for observation _i_ for category $c_i$ at location $s_i$ and time $t_i$. $\beta_1(c_i, t_i)$ represents temporal variation for each category and time, $\omega_i(s_i, c_i)$ represents spatial variation for each location and category, $\varepsilon_1(s_i, c_i, t_i)$ represents spatiotemporal variation for each location, category, and time, $\eta_1(v_i, c_i)$ represents vessel effects for each vessel and category, and $\nu_1(c_i, t_i)$ represents the effect of density covariates for each category and time. The second linear predictor is structured the same way. Both linear predictors incorporate fixed and random effects, and spatial and spatiotemporal variation are approximated as Gaussian Markov random fields [@thorson_2015 @thorson_comparing_2017 @thorson_2019].

Implementation of VAST models requires several structural and data inclusion decisions, as outlined in @thorson_2019. Decisions used in this effort will be discussed in the following subsections.

### Spatial, temporal, and spatiotemporal effects
Spatial, temporal, and spatiotemporal autocorrelation can be included in both linear predictors. A model selection process was used to justify the use of spatial and spatiotemporal random effects in the first and second linear predictors. The intercept for each linear predictor was defined as a fixed effect for each time step-- this ensures independent estimates of abundance for each time step, which is most appropriate for creating abundance indices [@thorson_2019]. Instead, a temporal component was estimated for the spatiotemporal components in both linear predictors. This is recommended for indices generated by multiple data sources that do not necessarily sample the same locations in every time step [@thorson_2019]. Without this estimation, unrealistic "hot spots" may develop or be carried through the time series when this is inappropriate. The use of a temporal component for spatiotemporal components can also help interpolate density in unsampled time steps [@thorson_2019].

### Spatial extent 
The NEFSC bottom trawl survey is conducted through Cape Hatteras, North Carolina, but the southern edge of the Atlantic cod range likely does not extend to this point. For the purposes of this model, the spatial extent of interest will be American waters on the continental shelf from the northern edge of the Gulf of Maine through the mouth of the Chesapeake Bay (Fig. 1).

```{r total spatial extent, echo=F, eval=T, fig.pos = "H"}
coast <- ecodata::coast
coast <- st_transform(coast, "EPSG:4326")
region <- st_read(here("Data/GIS/cod_region_wgs.shp"), quiet = T)

ggplot() +
  geom_sf(data=coast,fill='gray') +
  geom_sf(data=region, fill=alpha('lightblue', 0.7)) +
  coord_sf(xlim=c(-77, -65),
           ylim=c(36, 46)) +
  xlab('Longitude') + ylab('Latitude') +
  labs(caption = "Figure 0: Spatial extent for cod density models")

rm(region)

```

### VAST spatial referencing
It has been said that selection of the number of knots and spatial smoothers in VAST is "an art." For now, 200 knot locations will be used to make the SPDE grid on which VAST is run. Knot locations are determined by k-means clustering of the data, and are meant to represent standardized locations optimally placed among all surveyed locations. The model then creates an extrapolation grid. This grid is built on an SPDE approximation to a Matérn correlation function. For this model, anisotropy was expected and therefore included, though its inclusion was assessed in the model selection process. The default number of grid cells (2000) was used in the model, which results in cells that are approximately 25km by 25km.

![Figure 1: Location of extrapolation points and knots within the model spatial domain](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/VAST_runs/add_climate_aja4/GBK/Data_and_knots.png)

### Strata
There is evidence that cod spatial density varies among what are known to be distinct cod stock spatial areas [@linner_2022]. The model will therefore be run with each stock area as separate spatial strata (Fig. 2). Metrics of spatial dynamics, indices of abundance, and habitat associations can later be described for each stock area.

```{r spatial strata, echo=F, eval=T, fig.pos="H"}
strats <- st_read(here("Data/GIS/cod_all_strata.shp"), quiet=T)
coast <- ecodata::coast
coast <- st_transform(coast, "EPSG:4326")
ggplot() +
  geom_sf(data=coast,fill='gray') +
  geom_sf(data=strats, aes(fill=STRATA),
          alpha=0.7) +
  coord_sf(xlim=c(-77, -65),
           ylim=c(36, 46)) +
  xlab('Longitude') + ylab('Latitude') +
  labs(caption = "Figure 2: Cod stock areas within the model spatial domain")

rm(strats)

```

### Temporal extent
Though some surveys were initiated in the 1950s and 60s, the time period of interest to this study begins in 1982. Some studies have provided full data from 2022, and others have not. For this reason, the modeled time period will be 1982 - 2021.

### Seasonality
Time steps in the model will represent the spring and fall seasons of each year in the time series. Therefore, though there are 40 years of data there will be 80 time steps. This distinction is made to capture the seasonal spawning movements of adult cod. The spring season will be March through August of any year $x$. Fall will be September through December of year $x$ and January and February of year $x+1$. This is to ensure that the fall season is temporally continuous, rather than interrupted by the defined spring period. 
### Categories
Cod were modeled as three separate size classes, as it was expected that habitat utilization and spatial density would vary among size/ age groups. Small fish were defined as shorter than 39.1 cm total length or less than 0.58 kg. Medium fish were between 39.1 and 70.2 cm, or between 0.58 and 3.44 kg. Large fish were longer than 70.2 cm or heavier than 3.44 kg. This size structure roughly matches to ages 0-2 (pre-spawning), ages 2-5 (spawning), and ages 5+ (mature) cod, though this age structure was determined across all years and all spatial areas of the model domains and may be slightly different among time periods and locations. Uncommonly, fish without biological information could still be sorted into size categories. This typically occurred when the total weight of all fish caught in a tow was less than the maximum size limit of a singular small fish-- in this instance, all fish were assumed to belong in the small size category. Fish unable to be assigned to a size category could not be used in the model.

### Data type, link functions, and distributions
VAST models can use biomass, abundance, or encounter data as the response variable to quantify presence at each sampling location. In this model, abundance data were used; not every survey provided biological data including length and weight for every fish sampled, and therefore not every fish could be sorted into a size category by weight as would be necessary for a biomass-data model. As recommended by model developers for abundance-data models, a lognormal-Poisson distribution was chosen for the first linear predictor and an alternative "Poisson-link delta-model"was chosen for the second linear predictor.

### Area swept
VAST requires an input for the area swept for each tow. For surveys using bottom trawl methods, area swept was calculated as the distance covered by the tow multiplied by the wing spread. It is recommended that area swept be set to 1 for sampling gears with an unknown effective area swept. Initially, area swept for the bottom longline and Sentinel jigging surveys was set to 1. However, this created an issue of scaling and mixed units. Simple leave-one-out sensitivity tests were run to determine the influence of the bottom longline and Sentinel jigging surveys on the overall cod indices of abundance. Removing the Sentinel jigging survey had little impact on the modeled abundance of all three size classes of cod, and so it was excluded from further analysis. Removing the bottom longline survey reduced the abundance of medium and large cod by up to 50% in some years, and was therefore retained in further analyses. The description of the bottom longline motivation and methods in @mcelroy_2019 states that it was developed to as closely as possible match the sampling effort of the NEFSC bottom trawl survey. For this reason, average area swept of the NEFSC bottom trawl survey was also used as the input for the area swept of the bottom longline survey.

![Figure 3: Proportional comparison of fall cod abundance by age group, using model runs with all available data as the control.](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/Plot_output/fall_index_proportion_geardrop.png)

![Figure 4: Proportional comparison of spring cod abundance by age group, using model runs with all available data as the control.](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/Plot_output/spring_index_proportion_geardrop.png)


### Vessel effects
Each survey used in this modeling effort has its own set of sampling protocols. It is highly likely that this variability also causes variability in catchability. This random variation in catchability among levels of a grouping variable is referred to as vessel effects in the VAST model structure. For this model, vessel effects were included. It is understood that multiple vessels were sometimes used to complete each survey, but some surveys did not specify the vessel used for each sampling event. Therefore, we simply used survey as the grouping variable rather than vessel. VAST models covariation in vessel effects with a factor model, where variation in catchability between groups is a random effect.

### Density Covariates
VAST allows for the effects of both density and catchability covariates to be included in modeling efforts. Catchability covariates are processes one would expect to affect the ability to observe the target organism without necessarily affecting the distribution of the organism. Density covariates are processes that directly affect the distribution of the target organism, regardless of ability to observe it. Both covariates affect the catch rate of the target organism, but only density covariates are used to predict target organism density within the spatial domain. Therefore, VAST "controls for" catchability covariates and "conditions on" density covariates. VAST is unable to distinguish whether potential covariates should be treated as catchability or density covariates; this must be decided with theoretical insight from an analyst. 

In this model, catchability covariates were not used. As mentioned previously, differences in sampling design were included as vessel effects.

The model will include the effects of several potential density covariates. The final model will only include density covariates with significant impact, as determined by a model selection process that will be discussed later in this document.

#### Sediment data
Probability of mud, sand, gravel, cobble, and rock substrate existing in 1km by 1km grid cells through the entire continental shelf was provided by Brad Harris and Felipe Restrepo at Alaska Pacific University. These data are a expansion on the New England Fishery Management Council Swept Area Seabed Impact (SASI) model, which previously provided irregular polygons of distinct sediment grain types within the same spatial extent. Sediment observations from historical USGS sediment grabs and UMass Dartmouth's School for Marine Science and Technology (SMAST) video survey program are interpolated using an ordinary kriging approach to create the final 1km by 1km grid of sediment type probability.

```{r sediment plots, echo=F, eval=T, fig.pos="H"}
# Load sediments
load('C:/Users/klankowicz/Documents/GitHub/VAST-earlyattempts/data/RData_Storage/sediment_grids.RData')
rm(c, cent.vals, closed.areas, grid_noNA, hard, hospital_names,
   in.hard, in.soft, in.mix, mix, soft, temp, substrates, wss,
   hospital_labeller, i, surveys)

# Reshape grid
gridold <- grid
grid <- dplyr::select(grid, cobble, gravel, mud, sand, rock, 
                      cluster, Cell, outcome, geometry)
grid <- st_transform(grid, crs="EPSG:4326")
grid <- rbind(grid, grid, grid, grid, grid)
grid$value[1:1980] <- grid$cobble[1:1980]
grid$sed.ty[1:1980] <- 'cobble'

grid$value[1981:3960] <- grid$gravel[1:1980]
grid$sed.ty[1981:3960] <- 'gravel'

grid$value[3961:5940] <- grid$mud[1:1980]
grid$sed.ty[3961:5940] <- 'mud'

grid$value[5941:7920] <- grid$sand[1:1980]
grid$sed.ty[5941:7920] <- 'sand'

grid$value[7921:9900] <- grid$rock[1:1980]
grid$sed.ty[7921:9900] <- 'rock'

coast <- ecodata::coast
coast <- st_transform(coast, "EPSG:4326")

sed <- ggplot() +
  geom_sf(data=grid, col=NA, aes(fill=value)) +
  scale_fill_viridis_c(option='viridis',
                       na.value = NA,
                       direction = 1,
                       begin=0.2, end=1) +
  geom_sf(data=coast) +
  coord_sf(xlim=c(-77, -65),
           ylim=c(36, 46)) +
  facet_wrap(vars(sed.ty))+
  xlab('Longitude') + ylab('Latitude') +
  labs(caption = "Figure 5: Likelihood of each of five sediment types across the model spatial domain")+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.1, hjust=1, size=10))

sed$labels$fill <- 'Probability'

plot(sed)

rm(grid, gridold, sed)
```

#### Rugosity
Rugosity data comes from a dataset created by Ariell Friedman [@friedman_2012]. Rugosity is a unitless measure of elevation change over horizontal distance, and is calculated for grid cells with a 15 arc-second resolution.

```{r rugosity, echo=F, eval=T, fig.pos="H"}
# Load rugosity
rugos <- load("C:/Users/klankowicz/Documents/GitHub/Atlantic-Cod-Habitat-VAST/Data/Density_covariates/Rugosity/rast_rugosity.rdata")

coast <- ecodata::coast
coast <- st_transform(coast, st_crs(masked.raster))

rugos <- stack(masked.raster)

library(rasterVis)
rp <- gplot(rugos) + 
  geom_tile(aes(fill = value)) +
  scale_fill_gradientn(colours = rev(terrain.colors(225)),
                       na.value = 'white') +
  coord_equal(xlim=c(-77, -65),
           ylim=c(36, 46)) +
  ylab('Latitude') + xlab('Longitude') +
  labs(caption = "Figure 6: Rugosity within the model spatial domain")

rp$labels$fill <- 'Rugosity'

plot(rp)

rm(coast, masked.raster, rugos, rp)

```

#### Bathymetry
Most surveys recorded average depth at which the various gears were deployed. Some surveys did not provide information regarding gear depth. VAST models cannot have missing values in the density covariate inputs, so this inconsistency was an issue. Therefore, instead of using survey-reported values, depth at all survey locations was interpolated from GEBCO 15 arc-second bathymetry.

```{r bathy, echo=F, eval=T, fig.pos="H"}
# If you're interested in adding a bathymetry layer
library(marmap, quietly=T, verbose=F)
library(raster, quietly=T, verbose=F)
# Pull NOAA bathymetry data
Bathy <- getNOAA.bathy(lon1 = -78, lon2 = -65,
                       lat1 = 35, lat2 = 47, 
                       resolution = 1)
# Ignore any error messages, it still produces what we want.

# Now do a bit of data wrangling so we can plot it:
# Convert data to matrix
Bathy_Final <- as.matrix(Bathy)
class(Bathy_Final) <- "matrix"

# Reshape for plotting
BathyData <- Bathy_Final %>%
  as.data.frame() %>% 
  rownames_to_column(var = "lon") %>%
  gather(lat, value, -1) %>%
  mutate_all(funs(as.numeric))

# Set depth breaks and colors
dbreaks <- c(seq(0, 20, 2),
             seq(20, 40, 4),
             seq(40, 70, 5),
             seq(70, 100, 10),
             seq(100, 200, 20),
             seq(200, 400, 50),
             seq(400, 1000, 100),
             seq(1000, 2000, 200),
             seq(2000, 4000, 500),
             seq(4000, 7000, 1000))
dbreaks <- unique(dbreaks) * -1
dcol <- colorRampPalette(c("#DEF5E5", "#40498E"))
dcol <- dcol(length(dbreaks))

coast <- ecodata::coast
coast <- st_transform(coast, "EPSG:4326")

dep <- ggplot() +
  geom_contour_filled(data = BathyData, aes(x = lon, y = lat, z = value),
                      breaks = dbreaks) + 
  scale_fill_manual(values =  dcol) +
  geom_sf(data=coast) +
  coord_sf(xlim=c(-77, -65),
           ylim=c(36, 46)) +
  theme(legend.position = 'n') +
  xlab('Longitude') + ylab('Latitude') +
  labs(caption = 'Figure 7: Bathymetry within the model spatial domain')
plot(dep)

```

#### Sea Surface Temperature
The previous density covariates were temporally stationary. The following measures of temperature are temporally dynamic. For sea surface temperature, OISST values were pulled from NOAA data sources and extracted at observation locations. OISST values were compared to field measurements, when available, and the two were found to be generally similar. The following plot describes overall differences between field-measured SST and OISST when both measures were available for the same observation.

```{r oisst, echo=F, eval=T, fig.pos="H"}
agg_stn_all_OISST <- readRDS("C:/Users/klankowicz/Documents/GitHub/VAST-earlyattempts/Data/RData_Storage/agg_stn_all_OISST_agesep.rds")

# Create dataset of comparisons
comparesst <- agg_stn_all_OISST %>%
  dplyr::filter(YEAR>1981)%>%
  dplyr::select(SURFACE.TEMP, oisst, declon, declat, SURVEY) %>%
  na.omit()

comparesst <- comparesst[comparesst$SURVEY != "Sentinel",]

coast <- ecodata::coast
coast <- st_transform(coast, "EPSG:4326")

# Plot
ggplot(comparesst, aes(x=SURFACE.TEMP, y=oisst, color=SURVEY, fill=SURVEY)) +
  geom_point(alpha=0.8, pch=16)+
  geom_abline(intercept = 0, slope = 1) +
  labs(x = "Field surface temperature (deg C)",
       y = "OISST (deg C)",
       caption = "Figure 8: Comparison of field-measured SST to OISST")
```


#### Bottom Temperature
Bottom temperature data were provided by @du_pontavice_2023. Bottom temperature within approximately 5' by 5' grid cells were calculated at a daily timestep for 1982 to 2020. Because cod observation data were collected through 2021, bottom temperature data for this year were simply copied from 2020. This may not be accurate, and it may be better to exclude 2021 data in future efforts. Further, the bottom temperature product did not extend to the inshore strata included in the model. To fix this issue, bottom temperature was interpolated to the inshore strata from the existing data.

```{r bottom temp, echo=F, eval=T, fig.pos="H"}
bt <- brick(here('Data/Density_Covariates/Bottom_temp/hubert/extended_grd/1982.GRD'))
bt <- bt[[1]]
bt <- as.data.frame(bt, xy=TRUE)
colnames(bt) <- c('x', 'y', 'Bottom_temp')
bt <- st_as_sf(bt, coords=c('x', 'y'))
st_crs(bt) <- st_crs(coast)
bt <- bt[!is.na(bt$Bottom_temp),]

coast <- ecodata::coast
coast <- st_transform(coast, "EPSG:4326")

ggplot() +
  geom_sf(data=bt,
          aes(col=Bottom_temp)) +  
  geom_sf(data=coast, fill='gray') +
  coord_sf(xlim=c(-77, -65),
           ylim=c(36, 46)) +
  labs(caption = "Figure 9: Bottom temperature within the model spatial domain on 1 January 1982")
```

#### Climate Indices
Several climate indices have been demonstrated to have a relationship to cod abundance and distribution. For this model, NAO and AMO data were used as climate indices and tested for inclusion in the final model. NAO data are provided at a daily timestep within the model, whereas AMO was provided at a monthly timestep. Both were basin-wide indices, meaning the value does not change between spatial locations within the region.

### Density Covariate Collinearity
Potential density covariates were tested for collinearity. High correlations were found between two pairs: cobble and rock probability within 1km grid cells, and OISST and bottom temperature. Probability of rock and OISST were removed as covariates. For the first pair, rock was removed as bottom sample grabs (the bulk of sediment samples that make up the dataset) are more likely able to accurately characterize cobble distribution than larger boulders. For the second pair, OISST was removed as cod are groundfish and therefore more likely to be affected by bottom temperature than surface temperature. Once these two collinear relationships were addressed, the remainder of density covariates were not correlated and therefore were included in the model.

```{r collinearity, echo=F, eval=T, fig.pos="H"}
# Load data
surveys <- read.csv(here("Data/VAST_input/cod_agesep_VASTdata.csv"))

# Save covariates
covars <- dplyr::select(surveys,
                        LON, LAT, TIME, 
                        cobble_P, gravel_P, mud_P, sand_P, rock_P, 
                        rugos, BATHY.DEPTH, h_bt, oisst,
                        nao, amo)
covars$BATHY.DEPTH[covars$BATHY.DEPTH < 0] <- 
  covars$BATHY.DEPTH[covars$BATHY.DEPTH < 0] * -1
names(covars) <- c('Lon', 'Lat', 'Year', names(covars)[4:ncol(covars)])

# Test correlation
# Create correlation matrix
df_cormat <- dplyr::select(covars,                         
                           cobble_P, gravel_P, mud_P, sand_P, rock_P,
                           rugos, BATHY.DEPTH, h_bt, oisst,
                           nao, amo)
model.matrix(~0+., data=df_cormat) %>%
  cor(use="all.obs", method="spearman") %>%
  ggcorrplot(show.diag = F, type="lower", lab=TRUE, lab_size=3) + 
  labs(caption = "Figure 10: Density covariate correlation matrix")

```

## Model selection
The model selection process was completed in two steps. The first step compared models with and without anisotropy and/ or spatial and spatiotemporal random effects in the first and second linear predictors. This follows the model selection process of @ng_2021. The second step was to compare models with all possible combinations of the nine density covariates

### Model settings selection
Model settings were explored using model selection. Models were tested for different values in the Field Configuration settings (testing the use of spatial and spatiotemporal variation in the linear predictors), anisotropy, and overdispersion. AIC was used to compare models and restricted maximum likelihood (REML) was used in model construction to make comparison via AIC possible [@zuur_2009]. 

Model naming conventions are as follows:

* "alleffectson" - anisotropy on, spatial and spatiotemporal random effects in both linear predictors
* "noaniso" - anisotropy off, spatial and spatiotemporal random effects in both linear predictors
* "noomeps2" - anisotropy and spatial and spatiotemporal effects in linear predictor 1
* "noomeps2_noaniso" - anisotropy off, spatial and spatiotemporal effects in linear predictor 1
* "noomeps2_noeps1" - anisotropy and spatial effects in linear predictor 1
* "noomeps2_noeps1_noaniso" - anisotropy off, spatial effects in linear predictor 1
* "noomeps12" - anisotropy on, no spatial or spatiotemporal effects
* "noomeps12_noaniso" - anisotropy off, no spatial or spatiotemporal effects


The best model included anisotropy and spatial and spatiotemporal effects in both linear predictors.

```{r settings selection, echo=F, eval=T, fig.pos="H"}
# Set directory 
outdir <- here("Model_Refinement/Model_Structure")
# Call file names
moddirs <- list.dirs(outdir) 
# Remove name of upper level file
moddirs <- moddirs[-1]
# keep folder name
modnames <- list.dirs(outdir, full.names = FALSE)
modnames <- modnames[-1]

# function to apply extracting info
getmodinfo <- function(d.name){
  # read settings
  modpath <- stringr::str_split(d.name, "/", simplify = TRUE)
  modname <- modpath[length(modpath)]
  
  settings <- read.table(file.path(d.name, "settings.txt"), comment.char = "",
                         fill = TRUE, header = FALSE)
  
  n_x <- as.numeric(as.character(settings[(which(settings[,1]=="$n_x")+1),2]))
  grid_size_km <- as.numeric(as.character(settings[(
    which(settings[,1]=="$grid_size_km")+1),2]))
  max_cells <- as.numeric(as.character(settings[(
    which(settings[,1]=="$max_cells")+1),2]))
  use_anisotropy <- as.character(settings[(
    which(settings[,1]=="$use_anisotropy")+1),2])
  fine_scale <- as.character(settings[(
    which(settings[,1]=="$fine_scale")+1),2])
  bias.correct <- as.character(settings[(
    which(settings[,1]=="$bias.correct")+1),2])
  
  #FieldConfig
  if(settings[(which(settings[,1]=="$FieldConfig")+1),1]=="Component_1"){
    omega1 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+2),2])
    omega2 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+3),1])
    epsilon1 <- as.character(settings[(
      which(settings[,1]=="$FieldConfig")+4),2])
    epsilon2 <- as.character(settings[(
      which(settings[,1]=="$FieldConfig")+5),1])
    beta1 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+6),2])
    beta2 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+7),1])
  }
  
  if(settings[(which(settings[,1]=="$FieldConfig")+1),1]=="Omega1"){
    omega1 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+3),1])
    omega2 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+4),1])
    epsilon1 <- as.character(settings[(
      which(settings[,1]=="$FieldConfig")+3),2])
    epsilon2 <- as.character(settings[(
      which(settings[,1]=="$FieldConfig")+4),2])
    beta1 <- "IID"
    beta2 <- "IID"
  }
  
  #RhoConfig
  rho_beta1 <- as.numeric(as.character(settings[(
    which(settings[,1]=="$RhoConfig")+3),1]))
  rho_beta2 <- as.numeric(as.character(settings[(
    which(settings[,1]=="$RhoConfig")+3),2]))
  rho_epsilon1 <- as.numeric(as.character(settings[(
    which(settings[,1]=="$RhoConfig")+4),1]))
  rho_epsilon2 <- as.numeric(as.character(settings[(
    which(settings[,1]=="$RhoConfig")+4),2]))
  
  # read parameter estimates, object is called parameter_Estimates
  load(file.path(d.name, "parameter_estimates.RData"))
  
  AIC <- parameter_estimates$AIC[1]
  converged <- parameter_estimates$Convergence_check[1]
  fixedcoeff <- unname(parameter_estimates$number_of_coefficients[2])
  randomcoeff <- unname(parameter_estimates$number_of_coefficients[3])
  
  # return model atributes as a dataframe
  out <- data.frame(modname = modname,
                    n_x = n_x,
                    grid_size_km = grid_size_km,
                    max_cells = max_cells,
                    use_anisotropy = use_anisotropy,
                    fine_scale =  fine_scale,
                    bias.correct = bias.correct,
                    omega1 = omega1,
                    omega2 = omega2,
                    epsilon1 = epsilon1,
                    epsilon2 = epsilon2,
                    beta1 = beta1,
                    beta2 = beta2,
                    rho_epsilon1 = rho_epsilon1,
                    rho_epsilon2 = rho_epsilon2,
                    rho_beta1 = rho_beta1,
                    rho_beta2 = rho_beta2,
                    AIC = AIC,
                    converged = converged,
                    fixedcoeff = fixedcoeff,
                    randomcoeff = randomcoeff
  )
  return(out)
}

# Pull models
modselect <- purrr::map_dfr(moddirs, getmodinfo)

# Build table to compare models
modselect.200 <- modselect %>%
  filter(n_x == 200) %>%
  mutate(converged2 = case_when(str_detect(converged, 
                                           "no evidence") ~ "likely",
                                str_detect(converged, 
                                           "is likely not") ~ "unlikely",
                                TRUE ~ as.character(NA))) %>%
  mutate(deltaAIC = AIC-min(AIC)) %>%
  dplyr::select(modname, deltaAIC, fixedcoeff,
         randomcoeff, #use_anisotropy, 
         #omega1, omega2, epsilon1, epsilon2, 
         #beta1, beta2, 
         AIC, converged2) %>%
  arrange(AIC)

colnames(modselect.200) <- c('Model name', 
                             'delta AIC', 
                             'Fixed coefficients',
                             'Random coefficients', 
                             'AIC', 'converged')

# Print table
modselect.200 %>% 
  kable(booktabs=TRUE,
        caption='Table 1: Model selection step 1 outcomes') %>%
  kableExtra::kable_styling(
    latex_options = c("HOLD_position","striped"),
    stripe_color = "gray!10")
```

### Density covariate selection
Density covariates were selected for inclusion into the final model by running a subset of the original observation data (last 5 years of NEFSC bottom trawl data) with all possible combinations of variables as spatial density inputs. The four sediment likelihood variables (cobble, gravel, sand, and mud) were never separated. Models were then compared using AIC. Maximum likelihood was used to calculate AIC, as the spatial and spatiotemporal random effects did not change between models. 

Model naming conventions are as follows:

* "seds" - all sediment likeihood variables (cobble, gravel, sand, and mud)
* "rugos" - rugosity
* "bathy" - bathymetry
* "bottom" - bottom temperature
* "nao" - daily North Atlantic Oscillation index
* "amo" - monthly North Atlantic Oscillation index

The model with the lowest AIC was the model that included spatial density terms for all potential covariates.

```{r covars, echo=F, eval=T, fig.pos="H"}
covar.combo <- c('seds', 'rugos', 'bathy', 'bottom', 'nao', 'amo')
covar.combo <- do.call("c", lapply(seq_along(covar.combo), 
                                   function(i) combn(covar.combo, i, FUN = list)))
for(i in 1:length(covar.combo)){
  temp <- covar.combo[[i]]
  use <- length(temp)
  temp2 <- temp[[1]]
  
  if(use > 1){
    for(j in 2:use){
      temp2 <- paste0(temp2, temp[[j]])
    }
  }

  covar.combo[[i]] <- temp2
  #rm(temp, use, temp2)
}
covar.combo <- do.call(rbind, covar.combo)

mod.covar <- c("base", covar.combo[1:63])
# Model selection for covariates
# Set folder 
outdir <- here("Model_Refinement/Covariate_Selection2")
# List folders in outer folder
moddirs <- list.dirs(outdir) 
# Remove top level folder
moddirs <- moddirs[-c(1)]
# keep folder name
modnames <- mod.covar

# function to apply extracting info
getmodinfo <- function(d.name){
  # read settings
  modpath <- stringr::str_split(d.name, "/", simplify = TRUE)
  modname <- modpath[length(modpath)]
  
  settings <- read.table(file.path(d.name, "settings.txt"), comment.char = "",
                         fill = TRUE, header = FALSE)
  
  n_x <- as.numeric(as.character(settings[(which(settings[,1]=="$n_x")+1),2]))
  grid_size_km <- as.numeric(as.character(settings[(
    which(settings[,1]=="$grid_size_km")+1),2]))
  max_cells <- as.numeric(as.character(settings[(
    which(settings[,1]=="$max_cells")+1),2]))
  use_anisotropy <- as.character(settings[(
    which(settings[,1]=="$use_anisotropy")+1),2])
  fine_scale <- as.character(settings[(
    which(settings[,1]=="$fine_scale")+1),2])
  bias.correct <- as.character(settings[(
    which(settings[,1]=="$bias.correct")+1),2])
  
  #FieldConfig
  if(settings[(which(settings[,1]=="$FieldConfig")+1),1]=="Component_1"){
    omega1 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+2),2])
    omega2 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+3),1])
    epsilon1 <- as.character(settings[(
      which(settings[,1]=="$FieldConfig")+4),2])
    epsilon2 <- as.character(settings[(
      which(settings[,1]=="$FieldConfig")+5),1])
    beta1 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+6),2])
    beta2 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+7),1])
  }
  
  if(settings[(which(settings[,1]=="$FieldConfig")+1),1]=="Omega1"){
    omega1 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+3),1])
    omega2 <- as.character(settings[(which(settings[,1]=="$FieldConfig")+4),1])
    epsilon1 <- as.character(settings[(
      which(settings[,1]=="$FieldConfig")+3),2])
    epsilon2 <- as.character(settings[(
      which(settings[,1]=="$FieldConfig")+4),2])
    beta1 <- "IID"
    beta2 <- "IID"
  }
  
  
  #RhoConfig
  rho_beta1 <- as.numeric(as.character(settings[(
    which(settings[,1]=="$RhoConfig")+3),1]))
  rho_beta2 <- as.numeric(as.character(settings[(
    which(settings[,1]=="$RhoConfig")+3),2]))
  rho_epsilon1 <- as.numeric(as.character(settings[(
    which(settings[,1]=="$RhoConfig")+4),1]))
  rho_epsilon2 <- as.numeric(as.character(settings[(
    which(settings[,1]=="$RhoConfig")+4),2]))
  
  # read parameter estimates, object is called parameter_Estimates
  load(file.path(d.name, "parameter_estimates.RData"))
  
  AIC <- parameter_estimates$AIC[1]  
  converged <- parameter_estimates$Convergence_check[1]
  fixedcoeff <- unname(parameter_estimates$number_of_coefficients[2])
  randomcoeff <- unname(parameter_estimates$number_of_coefficients[3])
  
  
  # return model atributes as a dataframe
  out <- data.frame(modname = modname,
                    n_x = n_x,
                    grid_size_km = grid_size_km,
                    max_cells = max_cells,
                    use_anisotropy = use_anisotropy,
                    fine_scale =  fine_scale,
                    bias.correct = bias.correct,
                    omega1 = omega1,
                    omega2 = omega2,
                    epsilon1 = epsilon1,
                    epsilon2 = epsilon2,
                    beta1 = beta1,
                    beta2 = beta2,
                    rho_epsilon1 = rho_epsilon1,
                    rho_epsilon2 = rho_epsilon2,
                    rho_beta1 = rho_beta1,
                    rho_beta2 = rho_beta2,
                    AIC = AIC,
                    converged = converged,
                    fixedcoeff = fixedcoeff,
                    randomcoeff = randomcoeff
  )
  return(out)
}

# combine into one table for comparison
modselect <- purrr::map_dfr(moddirs, getmodinfo)

# Build table to compare models
modselect.cov <- modselect %>%
  filter(n_x == 200) %>%
  mutate(deltaAIC = AIC-min(AIC)) %>%
  dplyr::select(modname, deltaAIC, fixedcoeff,
         randomcoeff, #use_anisotropy, 
         #omega1, omega2, epsilon1, epsilon2, 
         #beta1, beta2, 
         AIC) %>%
  arrange(AIC)

modselect.cov1 <- modselect.cov[1:35,]
colnames(modselect.cov1) <- c('Model name',
                              'delta AIC',
                              'Fixed coefficients',
                              'Random coefficients',
                              'AIC')

modselect.cov2 <- modselect.cov[36:64,]
rownames(modselect.cov2) <- NULL
colnames(modselect.cov2) <- c('Model name',
                              'delta AIC',
                              'Fixed coefficients',
                              'Random coefficients',
                              'AIC')

# Print table
modselect.cov1 %>% 
  kable(booktabs=TRUE,
        caption='Table 2a: Model selection step 2 outcomes') %>%
  kableExtra::kable_styling(
    latex_options = c("HOLD_position","striped"),
    stripe_color = "gray!10")

modselect.cov2 %>% 
  kable(booktabs=TRUE,
        caption='Table 2b: Model selection step 2 outcomes') %>%
  kableExtra::kable_styling(
    latex_options = c("HOLD_position","striped"),
    stripe_color = "gray!10")
```

## Final model
After the model selection process, the best model included anisotropy, spatial, and spatiotemporal random effects in both linear predictors and density covariates for four classes of sediment types, rugosity, bathymetry, bottom temperature, NAO index, and AMO index. The model was structured with 200 knots and a Matern process spatial smoother to create 2000 grid cells of approximately 25km by 25km to extrapolate spatial density of three size classes of Atlantic cod in both the spring and fall seasons of each year from 1982 - 2021. The final model was also run with bias correction turned on, which uses the "epsilon method" to ensure that the mean and variation of generated indices of abundance are not biased due to their transformation by a nonlinear function in the modeling process [@thorson_2016].


# Results

## Spring Index

Large cod had the lowest abundance within the study area of all three size classes, and abundance for this group decreased over time. This result held for indices calculated within each of the four stock areas as well. Large cod were most abundant in the Georges Bank stock area. The center of gravity for large cod tended to be within the Georges Bank stock area and shifted slightly offshore over the time series. Effective area occupied decreased dramatically over time.

Medium cod had higher abundance than large cod, but also had a decreasing abundance trend over time. Similar to large cod, this result held when separating indices of abundance into each of the stock areas. Medium cod were most abundant in the Western Gulf of Maine stock area. The center of gravity for medium cod was typically on the border between the Western Gulf of Maine stock area and the Georges Bank stock area, and moved slightly offshore over time. Effective area occupied decreased over time.

Small cod had high variability through the time series, and seemed to have a jump in recruitment at around 2003. There is no clear trend in small cod abundance over time, though there may have been a slight increasing trend since 2003. Small cod are most abundant in the Southern New England stock area. The center of gravity for small cod was typically in either Southern New England or Western Gulf of Maine waters around Cape Cod, though occasional strong abundance years for coastal Maine pulled the center of gravity dramatically northwards. There is no clear trend for changes in effective area occupied over time.

```{r spring index, echo=F, eval=T, fig.pos = "H"}
spring <- read.csv("C:/Users/klankowicz/Documents/GitHub/Atlantic-Cod-Habitat-VAST/VAST_runs/add_climate_aja4/GBK/Index.csv")

strata_use<- data.frame(Stock = c( "GBK", "EGOM", "SNE", "WGOM", "ALL"),
                        Stratum =c('Stratum_1', 'Stratum_2', 'Stratum_3',
                                   'Stratum_4', 'Stratum_5'))
spring <- merge(spring, strata_use, by=c('Stratum'))
spring <- spring %>% 
  separate(Time, c('Year', 'Season'))
spring <- subset(spring, spring$Season == 'Spring')
spring$Year <- as.numeric(spring$Year)

ggplot() +
  geom_line(data=spring[spring$Stock == 'ALL',],
            aes(x=Year, y=Estimate, col=Category)) +
  geom_ribbon(data=spring[spring$Stock == 'ALL',],
              aes(x=Year, ymin = Estimate - Std..Error.for.Estimate,
                  ymax= Estimate + Std..Error.for.Estimate,
                  fill=Category),
              alpha = 0.2) +
  ylab('Index') +
  labs(caption = "Figure 11: Spring indices of abundance for all size classes")

ggplot() +
  geom_line(data=spring,
            aes(x=Year, y=Estimate, col=Category)) +
  geom_ribbon(data=spring,
              aes(x=Year, ymin = Estimate - Std..Error.for.Estimate,
                  ymax= Estimate + Std..Error.for.Estimate,
                  fill=Category),
              alpha = 0.2) +
  ylab('Index') +
  facet_wrap(vars(Stock),
             scales='free_y') +
  labs(caption = 'Figure 12: Spring indies of abundance within each stock area for all size classes')

```

![Figure 13: Large cod center of gravity and effective area occupied for all stock areas, spring seasons 1982 - 2021.](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/Plot_output_4/large.spring.png)

![Figure 14: Medium cod center of gravity and effective area occupied for all stock areas, spring seasons 1982 - 2021.](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/Plot_output_4/medium.spring.png)

![Figure 15: Small cod center of gravity and effective area occupied for all stock areas, spring seasons 1982 - 2021.](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/Plot_output_4/small.spring.png)

## Fall Index

Large cod usually had the lowest abundance within the study area of all three size classes, and abundance for this group decreased over time. This result held for indices calculated within each of the four stock areas as well. Large cod were most abundant in the Georges Bank stock area. The center of gravity for large cod tended to be between the Georges Bank and Western Gulf of Maine stock areas and shifted slightly north over the time series. Effective area occupied decreased dramatically over time.

Medium cod had the highest fall abundance of all size classes, but also had a decreasing abundance trend over time. Similar to large cod, this result held when separating indices of abundance into each of the stock areas. Medium cod were most abundant in the Western Gulf of Maine stock area. The center of gravity for medium cod was typically on the border between the Western Gulf of Maine stock area and the Georges Bank stock area, and moved slightly north over time. Effective area occupied decreased over time.

Unlike the spring indices, small cod did not have high variation in the fall indices. Small cod abundance had a decreasing trend throughout the time but had a rapid fall in abundance in the Southern New England and Western Gulf of Maine stock areas starting around 2010. The center of gravity for small cod was in the Western Gulf of Maine stock area, and there is no clear trend in movement over time. There is also no clear trend for changes in effective area occupied over time.

```{r fall index, echo=F, eval=T, fig.pos = "H"}
fall <- read.csv("C:/Users/klankowicz/Documents/GitHub/Atlantic-Cod-Habitat-VAST/VAST_runs/add_climate_aja4/GBK/Index.csv")

strata_use<- data.frame(Stock = c( "GBK", "EGOM", "SNE", "WGOM", "ALL"),
                        Stratum =c('Stratum_1', 'Stratum_2', 'Stratum_3',
                                   'Stratum_4', 'Stratum_5'))
fall <- merge(fall, strata_use, by=c('Stratum'))
fall <- fall %>% 
  separate(Time, c('Year', 'Season'))
fall <- subset(fall, fall$Season == 'Fall')
fall$Year <- as.numeric(fall$Year)

ggplot() +
  geom_line(data=fall[fall$Stock == 'ALL',],
            aes(x=Year, y=Estimate, col=Category)) +
  geom_ribbon(data=fall[fall$Stock == 'ALL',],
              aes(x=Year, ymin = Estimate - Std..Error.for.Estimate,
                  ymax= Estimate + Std..Error.for.Estimate,
                  fill=Category),
              alpha = 0.2) +
  ylab('Index') +
  labs(caption = 'Figure 16: Fall indices of abundance for all size classes')

ggplot() +
  geom_line(data=fall,
            aes(x=Year, y=Estimate, col=Category)) +
  geom_ribbon(data=fall,
              aes(x=Year, ymin = Estimate - Std..Error.for.Estimate,
                  ymax= Estimate + Std..Error.for.Estimate,
                  fill=Category),
              alpha = 0.2) +
  ylab('Index') +
  facet_wrap(vars(Stock),
             scales='free_y') +
  labs(caption = 'Figure 17: Fall indices of abundance within each stock area for each size class')

```

![Figure 18: Large cod center of gravity and effective area occupied for all stock areas, fall seasons 1982 - 2021.](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/Plot_output_4/large.fall.png)

![Figure 19: Medium cod center of gravity and effective area occupied for all stock areas, fall seasons 1982 - 2021.](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/Plot_output_4/medium.fall.png)

![Figure 20: Small cod center of gravity and effective area occupied for all stock areas, fall seasons 1982 - 2021.](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/Plot_output_4/small.fall.png)

## Habitat associations

After modeling, VAST extrapolation grid cells were stratified into hard, mixed, and soft bottom types using k-means clustering. Soft-bottom grid cells most likely contained only mud or sand, mixed-bottom cells contained similar likelihoods of mud, sand, and gravel, and hard-bottom grid cells likely contained cobble. The resulting map of sediment "hardness" was plotted with the aggregate spatial density of each cod size class for the spring and fall time series. 

Small cod were highly concentrated in nearshore waters around Martha's Vineyard and Narragansett Bay during the spring season, and more concentrated in nearshore waters around Boston Harbor in the fall. They were not strongly associated with any sediment type, though areas of high abundance in the fall were typically in areas of mixed sediment. Medium cod were more generally spread throughout the Gulf of Maine, and were typically found in highest density in areas of mixed sediment type. Large cod were highly dense in much smaller spatial areas. In the spring, this density was concentrated at the eastern end of Georges Bank and within areas of mixed sediment type. In the fall, large cod density was highest in the waters around the Westen Gulf of Maine closed area and within habitats of either mixed or hard sediment type.


![Figure 21: Small cod aggregate spatial density split by season, 1982 - 2021.](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/Plot_output/total_spatialdensity_small.png)

![Figure 22: Medium cod aggregate spatial density split by season, 1982 - 2021.](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/Plot_output/total_spatialdensity_medium.png)

![Figure 23: Large cod aggregate spatial density split by season, 1982 - 2021.](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/Plot_output/total_spatialdensity_large.png)


## Model diagnostics

The effect of anisotropy was stronger in the first linear predictor than the second, meaning that probability of encountering cod was similar for longer distances along a northeast-to-southwest axis than the abundance of cod along the same axis.

![Figure 24: Anisotropic effect in the first and second linear predictors](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/VAST_runs/add_climate_aja4/GBK/Aniso.png)

Residual plots did not indicate any violation of assumptions in the construction or implementation of the model. Mapping residuals within the model spatial domain did not highlight any spatial area as having a consistently poor fit.

![Figure 25: Quantile residuals of model run](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/VAST_runs/add_climate_aja4/GBK/Quantile_residuals.png)

![Figure 26: Quantile residuals of model run in spatial domain for every time step](C:/Users/klankowicz/Documents/GitHub/Atlantic-cod-habitat-VAST/VAST_runs/add_climate_aja4/GBK/Quantile_residuals_on_map.png)

# Discussion
Currently, groundfish population assessments rely heavily on data gathered with bottom trawl surveys. Despite evidence of increased cod abundance in areas with complex bottom habitats, locations with large-grain sediments or high rugosity are avoided or sampled at low frequency with bottom trawls due to the risks of damaging equipment. This is a major point of contention for fishing industry members, who believe that limiting information from complex habitats will not accurately reflect cod spatial distribution or abundance [@grabowski_2020]. Industry members instead support sampling across all habitat types and utilizing dynamic stratification, in which areas of similar habitat characteristics and likelihood of encountering cod are grouped into strata for sampling and later inclusion in assessment efforts. These strata cannot be built without accurate information on cod spatial density for all habitats within their spatial range.

VAST models can provide a flexible but robust framework to better assess groundfish populations across all habitat types within their spatial ranges. This is, of course, reliant on the collection of survey data in areas typically not well sampled by bottom trawls and by high-quality environmental and habitat data as density covariates.The model of cod spatial density created in this project utilized observation data from a suite of gear types and survey platforms, which bridged some of the data gaps inherent to models built with only bottom trawl survey data. The VAST modeling framework allowed for the use of density covariates to interpolate cod spatial density in non-sampled areas with known habitat and environmental characteristics. Further, VAST allowed for the estimation of spatial, temporal, and spatiotemporal correlation of cod abundance, as well as the inclusion of vessel effects, to facilitate the combination of observation data from multiple sources with varied protocols. This modeling process may be more favorable to industry stakeholders than models built with only bottom trawl observation data.

VAST models highlighted the variable spatial density of cod size classes across the four stock areas within the model spatial domain. There was a clear north-south directional gradient of abundance linked to size, where small cod were most abundant furthest south among the size classes and large cod were most abundant furthest north among the size classes. Further, VAST results highlighted the importance of relatively small areas within the stock areas to the size classes of cod. For example, the importance of Georges Bank to the large size class was highlighted; in the spring season, large cod abundance was highest in Georges Bank, driven by high spatial density at its eastern edge. For small cod, areas of high spring spatial density included the nearshore waters at the southwest edge of Martha's Vineyard.

Cod populations have continued to decline regardless of spatial area closures and massive reductions in fishing pressure. This trend is echoed in model results for all age classes in the fall time series, and all but small cod in the spring time series. The model does not support high emigration out of the model spatial domain as the cause of this population decline; stock centers of gravity for all size classes were typically well within the spatial bounds of the model. This indicates that factors other than fishing are playing a large role in preventing the recovery of the cod population. It is possible that reductions in fishing and spatial area closures are not protecting juveniles, which may be more important to cod population growth than adult survival and fecundity [@wright_2014]. VAST results have shown variable distribution of cod by size class, with smaller fish preferring more southern, inshore waters with variable sediment types. Characterization of bottom habitat and subsequent modeling of length-specific habitat associations could help address this uncertainty and lead to more effective protective measures.

Stock centers of gravity and effective area occupied are variable with cod size but generally indicate a northward and offshore shift and contraction in spatial distribution. Range shifts towards more northerly and deeper water have been commonly seen in North American marine species [@fredston_2021]. For cod, this range shift may be related to warming bottom temperatures in areas historically occupied by cod, particularly in the inshore and southern areas of their spatial range. As cod populations move, it will be important to quantify the possible reduction in high-suitability habitats. This will require robust models of cod habitat associations built on cod observation data and high-quality habitat data throughout the cod spatial range.

# References



